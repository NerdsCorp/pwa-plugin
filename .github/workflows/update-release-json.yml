name: Update Release JSON

on:
  release:
    types: [published, created, released]
  # Uncomment below for testing with tags (remove after testing)
  # push:
  #   tags:
  #     - '*'

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest
    
    steps:
      - name: Debug - Print event info
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Release tag: ${{ github.event.release.tag_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update update.json
        run: |
          # Extract version from the release tag (removes 'v' prefix if present)
          VERSION="${{ github.event.release.tag_name }}"
          VERSION="${VERSION#v}"
          
          # Get repository info
          REPO="${{ github.repository }}"
          
          # Create the JSON content
          cat > update.json << EOF
          {
            "*": {
              "version": "$VERSION",
              "download_url": "https://github.com/$REPO/archive/refs/tags/${{ github.event.release.tag_name }}.zip"
            }
          }
          EOF
          
          echo "✓ Updated update.json with version $VERSION"
          cat update.json
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add update.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update update.json to version ${{ github.event.release.tag_name }}"
            git push
            echo "✓ Changes pushed successfully"
          fi
